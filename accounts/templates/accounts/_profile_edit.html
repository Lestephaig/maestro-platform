<div class="profile-edit-section">
    <div class="card">
        <div class="card-header text-white" style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); border-bottom: 2px solid #f39c12;">
            <h4 class="mb-0">
                <i class="bi bi-pencil-square me-2"></i>
                {% if user.performer_profile %}
                    Редактирование профиля исполнителя
                {% elif user.client_profile %}
                    Редактирование профиля площадки
                {% elif user.agent_profile %}
                    Редактирование профиля организатора
                {% endif %}
            </h4>
        </div>
        <div class="card-body">
            <form hx-post="{% url 'profile_edit' %}" 
                  hx-target="#profile-content" 
                  hx-swap="innerHTML"
                  hx-encoding="multipart/form-data">
                {% csrf_token %}

                <div class="row g-4 profile-edit-columns">
                    <div class="col-md-6 form-column">
                        <!-- Основные поля -->
                        {% if user.performer_profile %}
                            <!-- Поле "Полное имя" -->
                            <div class="mb-3">
                                <label for="{{ form.full_name.id_for_label }}" class="form-label">
                                    <i class="bi bi-person me-2"></i>{{ form.full_name.label }}
                                </label>
                                {{ form.full_name }}
                                {% if form.full_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.full_name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Тип исполнителя -->
                            <div class="mb-3">
                                <label for="{{ form.performer_type.id_for_label }}" class="form-label">
                                    <i class="bi bi-person-badge me-2"></i>{{ form.performer_type.label }}
                                </label>
                                {{ form.performer_type }}
                                <div class="form-text">Выберите, являетесь ли вы вокалистом или инструменталистом</div>
                                {% if form.performer_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.performer_type.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Поле "Тип голоса" -->
                            <div class="mb-3" id="voice-type-field">
                                <label for="{{ form.voice_type.id_for_label }}" class="form-label">
                                    <i class="bi bi-mic me-2"></i>{{ form.voice_type.label }}
                                </label>
                                {{ form.voice_type }}
                                <div class="form-text">Выберите ваш тип голоса</div>
                                {% if form.voice_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.voice_type.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Поле "Инструмент" -->
                            <div class="mb-3 d-none" id="instrument-field">
                                <label for="{{ form.instrument.id_for_label }}" class="form-label">
                                    <i class="bi bi-music-note-beamed me-2"></i>{{ form.instrument.label }}
                                </label>
                                {{ form.instrument }}
                                <div class="form-text">Выберите основной инструмент</div>
                                {% if form.instrument.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.instrument.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Поле "Дата рождения" -->
                            <div class="mb-3">
                                <label for="{{ form.birth_date.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar-date me-2"></i>{{ form.birth_date.label }}
                                </label>
                                {{ form.birth_date }}
                                {% if form.birth_date.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.birth_date.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Поле "Фото" -->
                            <div class="mb-3">
                                <label for="{{ form.photo.id_for_label }}" class="form-label">
                                    <i class="bi bi-image me-2"></i>{{ form.photo.label }}
                                </label>
                                {{ form.photo }}
                                <div class="form-text">Загрузите ваше профессиональное фото</div>
                                {% if form.photo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.photo.errors.0 }}
                                    </div>
                                {% endif %}
                                <!-- Предпросмотр текущего фото -->
                                {% if user.performer_profile.photo %}
                                    <div class="mt-2">
                                        <img src="{{ user.performer_profile.photo.url }}" alt="Текущее фото" class="img-thumbnail" style="max-width: 200px;">
                                        <small class="text-muted d-block">Текущее фото</small>
                                    </div>
                                {% endif %}
                            </div>

                        {% elif user.client_profile %}
                            <!-- Поля для площадки -->
                            <div class="mb-3">
                                <label for="{{ form.company_name.id_for_label }}" class="form-label">
                                    <i class="bi bi-building me-2"></i>{{ form.company_name.label }}
                                </label>
                                {{ form.company_name }}
                                {% if form.company_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.company_name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.contact_person.id_for_label }}" class="form-label">
                                    <i class="bi bi-person me-2"></i>{{ form.contact_person.label }}
                                </label>
                                {{ form.contact_person }}
                                {% if form.contact_person.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.contact_person.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.website.id_for_label }}" class="form-label">
                                    <i class="bi bi-globe me-2"></i>{{ form.website.label }}
                                </label>
                                {{ form.website }}
                                {% if form.website.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.website.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        {% elif user.agent_profile %}
                            <!-- Поля для организатора -->
                            <div class="mb-3">
                                <label for="{{ form.display_name.id_for_label }}" class="form-label">
                                    <i class="bi bi-person-badge me-2"></i>{{ form.display_name.label }}
                                </label>
                                {{ form.display_name }}
                                {% if form.display_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.display_name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.agency_name.id_for_label }}" class="form-label">
                                    <i class="bi bi-building me-2"></i>{{ form.agency_name.label }}
                                </label>
                                {{ form.agency_name }}
                                {% if form.agency_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.agency_name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.specialization.id_for_label }}" class="form-label">
                                    <i class="bi bi-award me-2"></i>{{ form.specialization.label }}
                                </label>
                                {{ form.specialization }}
                                {% if form.specialization.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.specialization.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.experience_years.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar-event me-2"></i>{{ form.experience_years.label }}
                                </label>
                                {{ form.experience_years }}
                                {% if form.experience_years.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.experience_years.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.website.id_for_label }}" class="form-label">
                                    <i class="bi bi-globe me-2"></i>{{ form.website.label }}
                                </label>
                                {{ form.website }}
                                {% if form.website.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.website.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.bio.id_for_label }}" class="form-label">
                                    <i class="bi bi-journal-text me-2"></i>{{ form.bio.label }}
                                </label>
                                {{ form.bio }}
                                {% if form.bio.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.bio.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 form-column">
                        {% if user.performer_profile %}
                            <div class="mb-3">
                                <label for="{{ form.education.id_for_label }}" class="form-label">
                                    <i class="bi bi-mortarboard me-2"></i>{{ form.education.label }}
                                </label>
                                {{ form.education }}
                                <div class="form-text">Укажите ваше музыкальное образование, консерваторию, университет</div>
                                {% if form.education.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.education.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Поле "Биография" (полная ширина) -->
                {% if user.performer_profile %}
                    <div class="mb-4 form-wide-block">
                        <label for="{{ form.bio.id_for_label }}" class="form-label">
                            <i class="bi bi-file-text me-2"></i>{{ form.bio.label }}
                        </label>
                        {{ form.bio }}
                        <div class="form-text">Расскажите о себе, своем опыте, достижениях и образовании</div>
                        {% if form.bio.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.bio.errors.0 }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Поле "Достижения" (полная ширина) -->
                    <div class="mb-4 form-wide-block">
                        <label for="{{ form.achievements.id_for_label }}" class="form-label">
                            <i class="bi bi-trophy me-2"></i>{{ form.achievements.label }}
                        </label>
                        {{ form.achievements }}
                        <div class="form-text">Укажите ваши награды, премии, достижения в музыкальной карьере</div>
                        {% if form.achievements.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.achievements.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                {% endif %}

                <!-- Кнопки действий -->
                <div class="d-flex gap-3 justify-content-end">
                    <button type="button" class="btn btn-outline-light" 
                            hx-get="{% url 'profile_view' %}" hx-target="#profile-content" hx-swap="innerHTML">
                        <i class="bi bi-x-circle me-2"></i>Отмена
                    </button>
                    <button type="submit" class="btn" style="background: #f39c12; color: #2c3e50; font-weight: 600;">
                        <i class="bi bi-check-circle me-2"></i>Сохранить изменения
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.profile-edit-section .card {
    border: 1px solid rgba(243, 156, 18, 0.35);
    box-shadow: 0 28px 60px rgba(0, 0, 0, 0.45);
    background: linear-gradient(145deg, rgba(18, 18, 18, 0.92), rgba(34, 34, 34, 0.9));
    border-radius: 26px;
}

.profile-edit-section .card-header {
    background: linear-gradient(135deg, rgba(243, 156, 18, 0.25), rgba(243, 156, 18, 0.55));
    border-bottom: 1px solid rgba(243, 156, 18, 0.45);
    border-radius: 26px 26px 0 0;
}

.profile-edit-section .card-body {
    background: transparent;
    padding: 2.5rem;
}

.profile-edit-columns {
    align-items: stretch;
}

.profile-edit-section .form-column {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.profile-edit-section .form-column > .mb-3,
.profile-edit-section .form-column > .mb-4,
.profile-edit-section .form-wide-block {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 18px;
    padding: 1.1rem 1.35rem;
    box-shadow: 0 14px 35px rgba(0, 0, 0, 0.25);
    transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
}

.profile-edit-section .form-column > .mb-3:hover,
.profile-edit-section .form-column > .mb-4:hover,
.profile-edit-section .form-wide-block:hover {
    transform: translateY(-4px);
    box-shadow: 0 22px 60px rgba(243, 156, 18, 0.25);
    border-color: rgba(243, 156, 18, 0.5);
}

.form-label {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.92);
    letter-spacing: 0.015em;
    text-transform: uppercase;
    font-size: 0.85rem;
    margin-bottom: 0.65rem;
}

.form-control,
.form-select {
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    background: rgba(0, 0, 0, 0.3);
    color: #ffffff;
    padding: 0.85rem 1rem;
    transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
}

.form-control::placeholder,
.form-select::placeholder {
    color: rgba(255, 255, 255, 0.45);
}

.form-control:focus,
.form-select:focus {
    border-color: rgba(243, 156, 18, 0.65);
    box-shadow: 0 0 0 0.25rem rgba(243, 156, 18, 0.25);
    background: rgba(0, 0, 0, 0.45);
}

.form-text {
    color: rgba(255, 255, 255, 0.55);
    font-size: 0.8rem;
    margin-top: 0.45rem;
}

.profile-edit-section h6,
.profile-edit-section p {
    color: rgba(255, 255, 255, 0.9);
}

#photo-preview img {
    border-radius: 10px;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
}

.btn {
    border-radius: 0.75rem;
    font-weight: 600;
    padding: 0.8rem 1.6rem;
    letter-spacing: 0.02em;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 35px rgba(243, 156, 18, 0.35);
}

.btn-outline-light {
    border: 1px solid rgba(255, 255, 255, 0.25);
    color: rgba(255, 255, 255, 0.85);
    background: rgba(255, 255, 255, 0.05);
}

.btn-outline-light:hover {
    border-color: rgba(243, 156, 18, 0.55);
    color: #111;
    background: linear-gradient(135deg, rgba(243, 156, 18, 0.8), rgba(243, 156, 18, 1));
}

.btn[style] {
    background: linear-gradient(135deg, rgba(243, 156, 18, 0.9), rgba(243, 156, 18, 1)) !important;
    color: #1f1f1f !important;
}

@media (max-width: 992px) {
    .profile-edit-section .card-body {
        padding: 2rem 1.5rem;
    }
}

@media (max-width: 768px) {
    .profile-edit-section .card-body {
        padding: 1.75rem 1.25rem;
    }

    .profile-edit-section .form-column > .mb-3,
    .profile-edit-section .form-column > .mb-4 {
        padding: 1rem;
    }

    .d-flex.gap-3 {
        flex-direction: column;
    }
    
    .d-flex.gap-3 .btn {
        width: 100%;
    }
}
</style>

<script>
// Управление полями типа голоса и инструмента
(function () {
    function initPerformerTypeControls(root) {
        const context = root || document;
        const performerTypeField = context.querySelector('#{{ form.performer_type.id_for_label }}');
        const voiceField = context.querySelector('#voice-type-field');
        const instrumentField = context.querySelector('#instrument-field');

        if (!performerTypeField) {
            return;
        }

        const togglePerformerFields = () => {
            const value = performerTypeField.value;
            if (value === 'instrumentalist') {
                voiceField?.classList.add('d-none');
                instrumentField?.classList.remove('d-none');
            } else if (value === 'vocalist') {
                voiceField?.classList.remove('d-none');
                instrumentField?.classList.add('d-none');
            } else {
                voiceField?.classList.remove('d-none');
                instrumentField?.classList.remove('d-none');
            }
        };

        togglePerformerFields();

        if (!performerTypeField.dataset.toggleBound) {
            performerTypeField.addEventListener('change', togglePerformerFields);
            performerTypeField.dataset.toggleBound = 'true';
        }
    }

    if (document.readyState !== 'loading') {
        initPerformerTypeControls();
    } else {
        document.addEventListener('DOMContentLoaded', () => initPerformerTypeControls());
    }

    document.addEventListener('htmx:afterSwap', (event) => {
        const target = event.target || event.detail?.target;
        if (!target) {
            return;
        }
        if (target.id === 'profile-content' || target.closest?.('#profile-content')) {
            initPerformerTypeControls(target);
        }
    });
})();

</script>